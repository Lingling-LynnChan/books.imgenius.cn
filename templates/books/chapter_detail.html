{% extends 'base.html' %}

{% block title %}ç¬¬{{ chapter.chapter_number }}ç«  {{ chapter.title }} - {{ book.title }}{% endblock %}

{% block extra_css %}
<style>
    .chapter-content {
        font-size: 1.1em;
        line-height: 1.8;
        color: #333;
    }
    
    .chapter-content p {
        margin-bottom: 1.2em;
        text-indent: 2em;
    }
    
    .reading-header {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        padding: 2rem 0;
        margin-bottom: 2rem;
    }
    
    .chapter-nav {
        position: sticky;
        top: 0;
        z-index: 1000;
        background: rgba(255, 255, 255, 0.95);
        backdrop-filter: blur(10px);
        border-bottom: 1px solid #dee2e6;
        margin-bottom: 2rem;
    }
    
    .chapter-nav .nav-item {
        flex: 1;
    }
    
    .chapter-nav .btn {
        width: 100%;
        border-radius: 0;
    }
    
    @media (max-width: 768px) {
        .chapter-content {
            font-size: 1em;
            line-height: 1.6;
        }
        
        .chapter-content p {
            text-indent: 1.5em;
        }
    }
</style>
{% endblock %}

{% block content %}
<!-- é˜…è¯»æ ‡é¢˜åŒºåŸŸ -->
<div class="reading-header">
    <div class="container">
        <div class="row">
            <div class="col-12">
                <nav aria-label="breadcrumb" class="mb-3">
                    <ol class="breadcrumb">
                        <li class="breadcrumb-item">
                            <a href="{% url 'books:read' %}" class="text-white-50">
                                <i class="fas fa-book-open"></i> é˜…è¯»æ¿å—
                            </a>
                        </li>
                        <li class="breadcrumb-item">
                            <a href="{% url 'books:book_detail' book.id %}" class="text-white-50">
                                {{ book.title }}
                            </a>
                        </li>
                        <li class="breadcrumb-item active text-white">
                            ç¬¬{{ chapter.chapter_number }}ç« 
                        </li>
                    </ol>
                </nav>
                
                <h1 class="display-6 mb-2">ç¬¬{{ chapter.chapter_number }}ç« </h1>
                <h2 class="h3 mb-3">{{ chapter.title }}</h2>
                
                <div class="d-flex align-items-center">
                    <span class="me-3">
                        <i class="fas fa-user"></i> {{ book.author.display_name|default:book.author.email }}
                    </span>
                    <span class="me-3">
                        <i class="fas fa-calendar"></i> {{ chapter.updated_at|date:"Y-m-d H:i" }}
                    </span>
                    {% if is_author %}
                    <a href="{% url 'books:edit_chapter' book.id chapter.chapter_number %}" 
                       class="btn btn-outline-light btn-sm">
                        <i class="fas fa-edit"></i> ç¼–è¾‘ç« èŠ‚
                    </a>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
</div>

<!-- ç« èŠ‚å¯¼èˆªæ  -->
<div class="chapter-nav">
    <div class="container">
        <div class="d-flex">
            {% if prev_chapter %}
            <div class="nav-item">
                <a href="{% url 'books:chapter_detail' book.id prev_chapter.chapter_number %}" 
                   class="btn btn-outline-primary">
                    <i class="fas fa-chevron-left"></i> ä¸Šä¸€ç« 
                </a>
            </div>
            {% else %}
            <div class="nav-item">
                <button class="btn btn-outline-secondary" disabled>
                    <i class="fas fa-chevron-left"></i> ä¸Šä¸€ç« 
                </button>
            </div>
            {% endif %}
            
            <div class="nav-item">
                <a href="{% url 'books:book_detail' book.id %}" class="btn btn-outline-secondary">
                    <i class="fas fa-list"></i> ç›®å½•
                </a>
            </div>
            
            {% if next_chapter %}
            <div class="nav-item">
                <a href="{% url 'books:chapter_detail' book.id next_chapter.chapter_number %}" 
                   class="btn btn-outline-primary">
                    ä¸‹ä¸€ç«  <i class="fas fa-chevron-right"></i>
                </a>
            </div>
            {% else %}
            <div class="nav-item">
                <button class="btn btn-outline-secondary" disabled>
                    ä¸‹ä¸€ç«  <i class="fas fa-chevron-right"></i>
                </button>
            </div>
            {% endif %}
        </div>
    </div>
</div>

<!-- ç« èŠ‚å†…å®¹ -->
<div class="container">
    <div class="row justify-content-center">
        <div class="col-lg-8">
            <div class="card border-0 shadow-sm">
                <div class="card-body p-4 p-md-5">
                    <!-- å®¡æ ¸çŠ¶æ€æç¤ºï¼ˆä»…ä½œè€…å¯è§ï¼‰ -->
                    {% if is_author %}
                        {% comment %} æ£€æŸ¥æ˜¯å¦ç¡®å®è¢«æ‹’ç»ä¸”éœ€è¦æ˜¾ç¤ºæ‹’ç»åŸå›  {% endcomment %}
                        {% if chapter.adm_check_title == 'rejected' or chapter.adm_check_content == 'rejected' %}
                            {% comment %} ç®¡ç†å‘˜æ˜ç¡®æ‹’ç» {% endcomment %}
                            <div class="alert alert-warning">
                                <h6><i class="fas fa-exclamation-triangle"></i> å®¡æ ¸æœªé€šè¿‡</h6>
                                {% if chapter.adm_check_title == 'rejected' and chapter.title_reject_reason %}
                                <p class="mb-1"><strong>æ ‡é¢˜ï¼š</strong>{{ chapter.title_reject_reason }}</p>
                                {% endif %}
                                {% if chapter.adm_check_content == 'rejected' and chapter.content_reject_reason %}
                                <p class="mb-0"><strong>å†…å®¹ï¼š</strong>{{ chapter.content_reject_reason }}</p>
                                {% endif %}
                            </div>
                        {% elif chapter.ai_check_title == 'rejected' and chapter.adm_check_title is None %}
                            {% comment %} AIæ‹’ç»ä¸”ç®¡ç†å‘˜æœªå®¡æ ¸æ ‡é¢˜ {% endcomment %}
                            <div class="alert alert-warning">
                                <h6><i class="fas fa-exclamation-triangle"></i> å®¡æ ¸æœªé€šè¿‡</h6>
                                {% if chapter.title_reject_reason %}
                                <p class="mb-1"><strong>æ ‡é¢˜ï¼š</strong>{{ chapter.title_reject_reason }}</p>
                                {% endif %}
                            </div>
                        {% elif chapter.ai_check_content == 'rejected' and chapter.adm_check_content is None %}
                            {% comment %} AIæ‹’ç»ä¸”ç®¡ç†å‘˜æœªå®¡æ ¸å†…å®¹ {% endcomment %}
                            <div class="alert alert-warning">
                                <h6><i class="fas fa-exclamation-triangle"></i> å®¡æ ¸æœªé€šè¿‡</h6>
                                {% if chapter.content_reject_reason %}
                                <p class="mb-0"><strong>å†…å®¹ï¼š</strong>{{ chapter.content_reject_reason }}</p>
                                {% endif %}
                            </div>
                        {% elif chapter.ai_check_title == 'pending' or chapter.ai_check_content == 'pending' %}
                        <div class="alert alert-info">
                            <i class="fas fa-clock"></i> å†…å®¹æ­£åœ¨å®¡æ ¸ä¸­ï¼Œè¯·è€å¿ƒç­‰å¾…...
                        </div>
                        {% elif chapter.adm_check_title != 'approved' or chapter.adm_check_content != 'approved' %}
                        <div class="alert alert-warning">
                            <i class="fas fa-hourglass-half"></i> å†…å®¹ç­‰å¾…ç®¡ç†å‘˜æœ€ç»ˆå®¡æ ¸
                        </div>
                        {% endif %}
                    {% endif %}
                    
                    <!-- ç« èŠ‚æ­£æ–‡ -->
                    <div class="chapter-content">
                        {{ chapter.content|linebreaks }}
                    </div>
                    
                    <!-- ç« èŠ‚åº•éƒ¨ä¿¡æ¯ -->
                    <div class="mt-5 pt-4 border-top">
                        <div class="row">
                            <div class="col-md-6">
                                <p class="text-muted mb-1">
                                    <i class="fas fa-clock"></i> æ›´æ–°æ—¶é—´ï¼š{{ chapter.updated_at|date:"Yå¹´mæœˆdæ—¥ H:i" }}
                                </p>
                                <p class="text-muted mb-0">
                                    <i class="fas fa-file-word"></i> å­—æ•°ï¼š{{ chapter.content|length }}
                                </p>
                            </div>
                            <div class="col-md-6 text-md-end">
                                {% if is_author %}
                                <a href="{% url 'books:edit_chapter' book.id chapter.chapter_number %}" 
                                   class="btn btn-outline-primary btn-sm">
                                    <i class="fas fa-edit"></i> ç¼–è¾‘æœ¬ç« 
                                </a>
                                {% endif %}
                                <a href="{% url 'books:book_detail' book.id %}" 
                                   class="btn btn-outline-secondary btn-sm">
                                    <i class="fas fa-list"></i> è¿”å›ç›®å½•
                                </a>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- åº•éƒ¨å¯¼èˆª -->
<div class="container mt-4">
    <div class="row">
        <div class="col-12">
            <div class="d-flex justify-content-between">
                {% if prev_chapter %}
                <a href="{% url 'books:chapter_detail' book.id prev_chapter.chapter_number %}" 
                   class="btn btn-primary">
                    <i class="fas fa-chevron-left"></i> ä¸Šä¸€ç« ï¼š{{ prev_chapter.title|truncatechars:20 }}
                </a>
                {% else %}
                <div></div>
                {% endif %}
                
                {% if next_chapter %}
                <a href="{% url 'books:chapter_detail' book.id next_chapter.chapter_number %}" 
                   class="btn btn-primary">
                    ä¸‹ä¸€ç« ï¼š{{ next_chapter.title|truncatechars:20 }} <i class="fas fa-chevron-right"></i>
                </a>
                {% else %}
                <div class="text-center">
                    <span class="text-muted">
                        <i class="fas fa-flag-checkered"></i> å·²è¯»å®Œæœ€æ–°ç« èŠ‚
                    </span>
                </div>
                {% endif %}
            </div>
        </div>
    </div>
</div>

<!-- è¯„è®ºåŒºåŸŸ -->
<div class="container mt-5">
    <div class="row justify-content-center">
        <div class="col-lg-8">
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0">
                        <i class="fas fa-comments"></i> æœ¬ç« è¯„è®º
                        <span class="badge bg-secondary ms-2">å³å°†å¼€æ”¾</span>
                    </h5>
                </div>
                <div class="card-body text-center text-muted">
                    <i class="fas fa-comment-slash fa-3x mb-3"></i>
                    <p>è¯„è®ºåŠŸèƒ½æ­£åœ¨å¼€å‘ä¸­ï¼Œæ•¬è¯·æœŸå¾…...</p>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
$(document).ready(function() {
    // é˜…è¯»è¿›åº¦è®°å½•
    function updateReadingProgress() {
        const bookId = {{ book.id }};
        const chapterNumber = {{ chapter.chapter_number }};
        
        // è¿™é‡Œå¯ä»¥æ·»åŠ é˜…è¯»è¿›åº¦è®°å½•é€»è¾‘
        localStorage.setItem(`reading_progress_${bookId}`, chapterNumber);
    }
    
    // é¡µé¢åŠ è½½å®Œæˆåè®°å½•é˜…è¯»è¿›åº¦
    updateReadingProgress();
    
    // å¿«æ·é”®å¯¼èˆª
    $(document).keydown(function(e) {
        // å·¦ç®­å¤´ - ä¸Šä¸€ç« 
        if (e.keyCode === 37 && !$(e.target).is('input, textarea')) {
            {% if prev_chapter %}
            window.location.href = "{% url 'books:chapter_detail' book.id prev_chapter.chapter_number %}";
            {% endif %}
        }
        
        // å³ç®­å¤´ - ä¸‹ä¸€ç« 
        if (e.keyCode === 39 && !$(e.target).is('input, textarea')) {
            {% if next_chapter %}
            window.location.href = "{% url 'books:chapter_detail' book.id next_chapter.chapter_number %}";
            {% endif %}
        }
        
        // ESC - è¿”å›ç›®å½•
        if (e.keyCode === 27) {
            window.location.href = "{% url 'books:book_detail' book.id %}";
        }
    });
    
    // æ»šåŠ¨åˆ°é¡¶éƒ¨æŒ‰é’®
    $(window).scroll(function() {
        if ($(this).scrollTop() > 300) {
            if ($('#scroll-to-top').length === 0) {
                $('body').append(`
                    <button id="scroll-to-top" class="btn btn-primary" 
                            style="position: fixed; bottom: 20px; right: 20px; z-index: 1000;">
                        <i class="fas fa-chevron-up"></i>
                    </button>
                `);
                
                $('#scroll-to-top').click(function() {
                    $('html, body').animate({scrollTop: 0}, 300);
                });
            }
        } else {
            $('#scroll-to-top').remove();
        }
    });
    
    // æ·»åŠ é˜…è¯»æç¤º
    let readingTips = [
        'ğŸ’¡ ä½¿ç”¨å·¦å³ç®­å¤´é”®å¯ä»¥å¿«é€Ÿç¿»é¡µ',
        'ğŸ’¡ æŒ‰ESCé”®å¯ä»¥è¿”å›ç›®å½•',
        'ğŸ’¡ é¡µé¢ä¼šè‡ªåŠ¨è®°å½•æ‚¨çš„é˜…è¯»è¿›åº¦'
    ];
    
    if (readingTips.length > 0) {
        setTimeout(function() {
            const tip = readingTips[Math.floor(Math.random() * readingTips.length)];
            $('body').append(`
                <div class="toast show position-fixed bottom-0 end-0 m-3" style="z-index: 1050;">
                    <div class="toast-header">
                        <i class="fas fa-lightbulb text-warning me-2"></i>
                        <strong class="me-auto">é˜…è¯»æç¤º</strong>
                        <button type="button" class="btn-close" data-bs-dismiss="toast"></button>
                    </div>
                    <div class="toast-body">${tip}</div>
                </div>
            `);
            
            // 5ç§’åè‡ªåŠ¨éšè—
            setTimeout(function() {
                $('.toast').fadeOut();
            }, 5000);
        }, 2000);
    }
});
</script>
{% endblock %}
