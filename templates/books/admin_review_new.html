{% extends 'base.html' %}

{% block title %}内容审核 - 管理员后台{% endblock %}

{% block content %}
<div class="row">
    <div class="col-12">
        <div class="card">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h4 class="mb-0">
                    <i class="fas fa-gavel"></i> 内容审核
                </h4>
                <a href="{% url 'books:admin_panel' %}" class="btn btn-outline-secondary">
                    <i class="fas fa-arrow-left"></i> 返回后台
                </a>
            </div>
            <div class="card-body">
                {% if book %}
                    <div class="row">
                        <div class="col-md-8">
                            <h5>作品信息</h5>
                            
                            <!-- 标题审核 -->
                            <div class="card mb-3">
                                <div class="card-header">
                                    <h6 class="mb-0">
                                        <i class="fas fa-heading"></i> 作品标题
                                        {% if needs_title_review %}
                                            <span class="badge bg-warning ms-2">需要审核</span>
                                        {% endif %}
                                    </h6>
                                </div>
                                <div class="card-body">
                                    <div class="row">
                                        <div class="col-md-6">
                                            <h6>当前标题</h6>
                                            <p class="text-muted">{{ book.title|default:"无" }}</p>
                                        </div>
                                        <div class="col-md-6">
                                            <h6>待审核标题</h6>
                                            <p><strong>{{ book.title_pending|default:"无" }}</strong></p>
                                        </div>
                                    </div>
                                    
                                    <div class="mt-3">
                                        <h6>审核状态</h6>
                                        <p>
                                            AI审核: 
                                            {% if book.ai_check_title == 'approved' %}
                                                <span class="badge bg-success">✅ 通过</span>
                                            {% elif book.ai_check_title == 'rejected' %}
                                                <span class="badge bg-danger">❌ 不通过</span>
                                            {% else %}
                                                <span class="badge bg-warning">⏳ 待审核</span>
                                            {% endif %}
                                            
                                            | 管理员审核: 
                                            {% if book.adm_check_title == 'approved' %}
                                                <span class="badge bg-success">✅ 通过</span>
                                            {% elif book.adm_check_title == 'rejected' %}
                                                <span class="badge bg-danger">❌ 不通过</span>
                                            {% else %}
                                                <span class="badge bg-secondary">⏸️ 未审核</span>
                                            {% endif %}
                                        </p>
                                        
                                        {% if book.title_reject_reason %}
                                            <div class="alert alert-warning">
                                                <strong>拒绝原因:</strong> {{ book.title_reject_reason }}
                                            </div>
                                        {% endif %}
                                    </div>
                                    
                                    {% if needs_title_review %}
                                        <div class="mt-3">
                                            <button type="button" class="btn btn-success btn-sm" onclick="approveTitle()">
                                                <i class="fas fa-check"></i> 通过标题
                                            </button>
                                            
                                            <button type="button" class="btn btn-danger btn-sm ms-2" 
                                                    data-bs-toggle="modal" data-bs-target="#rejectTitleModal">
                                                <i class="fas fa-times"></i> 拒绝标题
                                            </button>
                                        </div>
                                    {% endif %}
                                </div>
                            </div>
                            
                            <!-- 简介审核 -->
                            <div class="card mb-3">
                                <div class="card-header">
                                    <h6 class="mb-0">
                                        <i class="fas fa-file-text"></i> 作品简介
                                        {% if needs_description_review %}
                                            <span class="badge bg-warning ms-2">需要审核</span>
                                        {% endif %}
                                    </h6>
                                </div>
                                <div class="card-body">
                                    <div class="row">
                                        <div class="col-md-6">
                                            <h6>当前简介</h6>
                                            <div class="border p-2 bg-light text-muted" style="max-height: 150px; overflow-y: auto;">
                                                {{ book.description|default:"无"|linebreaks }}
                                            </div>
                                        </div>
                                        <div class="col-md-6">
                                            <h6>待审核简介</h6>
                                            <div class="border p-2" style="max-height: 150px; overflow-y: auto;">
                                                <strong>{{ book.description_pending|default:"无"|linebreaks }}</strong>
                                            </div>
                                        </div>
                                    </div>
                                    
                                    <div class="mt-3">
                                        <h6>审核状态</h6>
                                        <p>
                                            AI审核: 
                                            {% if book.ai_check_description == 'approved' %}
                                                <span class="badge bg-success">✅ 通过</span>
                                            {% elif book.ai_check_description == 'rejected' %}
                                                <span class="badge bg-danger">❌ 不通过</span>
                                            {% else %}
                                                <span class="badge bg-warning">⏳ 待审核</span>
                                            {% endif %}
                                            
                                            | 管理员审核: 
                                            {% if book.adm_check_description == 'approved' %}
                                                <span class="badge bg-success">✅ 通过</span>
                                            {% elif book.adm_check_description == 'rejected' %}
                                                <span class="badge bg-danger">❌ 不通过</span>
                                            {% else %}
                                                <span class="badge bg-secondary">⏸️ 未审核</span>
                                            {% endif %}
                                        </p>
                                        
                                        {% if book.description_reject_reason %}
                                            <div class="alert alert-warning">
                                                <strong>拒绝原因:</strong> {{ book.description_reject_reason }}
                                            </div>
                                        {% endif %}
                                    </div>
                                    
                                    {% if needs_description_review %}
                                        <div class="mt-3">
                                            <button type="button" class="btn btn-success btn-sm" onclick="approveDescription()">
                                                <i class="fas fa-check"></i> 通过简介
                                            </button>
                                            
                                            <button type="button" class="btn btn-danger btn-sm ms-2" 
                                                    data-bs-toggle="modal" data-bs-target="#rejectDescModal">
                                                <i class="fas fa-times"></i> 拒绝简介
                                            </button>
                                        </div>
                                    {% endif %}
                                </div>
                            </div>
                        </div>
                        
                        <div class="col-md-4">
                            <div class="card">
                                <div class="card-header">
                                    <h6 class="mb-0"><i class="fas fa-info-circle"></i> 作品信息</h6>
                                </div>
                                <div class="card-body">
                                    <p><strong>作者:</strong> {{ book.author.display_name }}</p>
                                    <p><strong>创建时间:</strong> {{ book.created_at|date:"Y-m-d H:i" }}</p>
                                    <p><strong>更新时间:</strong> {{ book.updated_at|date:"Y-m-d H:i" }}</p>
                                    
                                    <hr>
                                    
                                    <h6>审核状态汇总</h6>
                                    {% if has_pending_review %}
                                        <div class="alert alert-warning">
                                            <i class="fas fa-exclamation-triangle"></i>
                                            该作品需要您的审核
                                        </div>
                                    {% else %}
                                        <div class="alert alert-success">
                                            <i class="fas fa-check-circle"></i>
                                            该作品无需审核
                                        </div>
                                    {% endif %}
                                </div>
                            </div>
                            
                            <div class="card mt-3">
                                <div class="card-header">
                                    <h6 class="mb-0"><i class="fas fa-lightbulb"></i> 审核指南</h6>
                                </div>
                                <div class="card-body">
                                    <ul class="list-unstyled small">
                                        <li><i class="fas fa-check text-success"></i> 内容健康向上</li>
                                        <li><i class="fas fa-check text-success"></i> 语言文明规范</li>
                                        <li><i class="fas fa-check text-success"></i> 无违法违规内容</li>
                                        <li><i class="fas fa-check text-success"></i> 符合平台规定</li>
                                    </ul>
                                </div>
                            </div>
                        </div>
                    </div>
                {% elif error %}
                    <div class="alert alert-danger">
                        <i class="fas fa-exclamation-triangle"></i> {{ error }}
                    </div>
                {% else %}
                    <div class="alert alert-warning">
                        <i class="fas fa-question-circle"></i> 未找到要审核的内容
                    </div>
                {% endif %}
            </div>
        </div>
    </div>
</div>

<!-- 拒绝标题模态框 -->
<div class="modal fade" id="rejectTitleModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">拒绝标题</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="mb-3">
                    <label for="titleRejectReason" class="form-label">拒绝原因</label>
                    <textarea class="form-control" id="titleRejectReason" rows="3" 
                              placeholder="请说明拒绝原因..."></textarea>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
                <button type="button" class="btn btn-danger" onclick="rejectTitle()">确认拒绝</button>
            </div>
        </div>
    </div>
</div>

<!-- 拒绝简介模态框 -->
<div class="modal fade" id="rejectDescModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">拒绝简介</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="mb-3">
                    <label for="descRejectReason" class="form-label">拒绝原因</label>
                    <textarea class="form-control" id="descRejectReason" rows="3" 
                              placeholder="请说明拒绝原因..."></textarea>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
                <button type="button" class="btn btn-danger" onclick="rejectDescription()">确认拒绝</button>
            </div>
        </div>
    </div>
</div>

<script>
$(document).ready(function() {
    // 审核功能
    window.approveTitle = function() {
        submitReview('approve', '', 'title');
    };
    
    window.rejectTitle = function() {
        const reason = $('#titleRejectReason').val().trim();
        if (!reason) {
            alert('请填写拒绝原因');
            return;
        }
        $('#rejectTitleModal').modal('hide');
        submitReview('reject', reason, 'title');
    };
    
    window.approveDescription = function() {
        submitReview('approve', '', 'description');
    };
    
    window.rejectDescription = function() {
        const reason = $('#descRejectReason').val().trim();
        if (!reason) {
            alert('请填写拒绝原因');
            return;
        }
        $('#rejectDescModal').modal('hide');
        submitReview('reject', reason, 'description');
    };
    
    function submitReview(action, reason, type) {
        const data = {
            csrfmiddlewaretoken: $('[name=csrfmiddlewaretoken]').val()
        };
        
        if (type === 'title') {
            data.title_action = action;
            data.title_reason = reason;
        } else {
            data.description_action = action;
            data.description_reason = reason;
        }
        
        $.post(window.location.href, data)
        .done(function(response) {
            if (response.success) {
                // 显示成功消息
                const alertHtml = `
                    <div class="alert alert-success alert-dismissible fade show" role="alert">
                        <i class="fas fa-check-circle"></i> ${response.message}
                        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                    </div>
                `;
                $('.card-body').first().prepend(alertHtml);
                
                // 2秒后刷新页面
                setTimeout(function() {
                    window.location.reload();
                }, 2000);
            } else {
                alert('操作失败: ' + response.error);
            }
        })
        .fail(function() {
            alert('网络错误，请稍后重试');
        });
    }
});
</script>

<!-- 添加CSRF令牌 -->
{% csrf_token %}
{% endblock %}
