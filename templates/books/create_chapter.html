{% extends 'base.html' %}

{% block title %}创建新章节 - {{ book.title }}{% endblock %}

{% block content %}
<div class="row">
    <div class="col-md-8">
        <div class="card">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h4 class="mb-0">
                    <i class="fas fa-plus"></i> 创建新章节
                </h4>
                <div>
                    <a href="{% url 'books:chapter_list' book.id %}" class="btn btn-outline-secondary btn-sm">
                        <i class="fas fa-list"></i> 返回目录
                    </a>
                </div>
            </div>
            <div class="card-body">
                <nav aria-label="breadcrumb" class="mb-3">
                    <ol class="breadcrumb">
                        <li class="breadcrumb-item">
                            <a href="{% url 'books:create' %}">创作</a>
                        </li>
                        <li class="breadcrumb-item">
                            <a href="{% url 'books:chapter_list' book.id %}">{{ book.title }}</a>
                        </li>
                        <li class="breadcrumb-item active">
                            创建新章节
                        </li>
                    </ol>
                </nav>
                
                <form method="post" id="chapterForm">
                    {% csrf_token %}
                    
                    <div class="mb-3">
                        <label for="title" class="form-label">
                            章节标题 <span class="text-danger">*</span>
                        </label>
                        <input type="text" class="form-control" id="title" name="title" 
                               placeholder="请输入章节标题" maxlength="200" required>
                        <div class="form-text">
                            <i class="fas fa-lightbulb"></i> 起一个引人入胜的章节标题
                        </div>
                    </div>
                    
                    <div class="mb-3">
                        <label for="content" class="form-label">
                            章节内容 <span class="text-danger">*</span>
                        </label>
                        <textarea class="form-control" id="content" name="content" 
                                  rows="20" placeholder="开始您的创作..." required></textarea>
                        <div class="form-text">
                            <i class="fas fa-pen"></i> 发挥您的创意，创作精彩内容
                        </div>
                    </div>
                    
                    <div class="alert alert-info">
                        <i class="fas fa-shield-alt"></i> 
                        <strong>温馨提示：</strong>
                        章节创建后将进行内容审核，审核通过后才能在阅读板块展示。
                        请确保内容健康积极，避免敏感词汇。
                    </div>
                    
                    <div class="d-flex justify-content-between">
                        <a href="{% url 'books:chapter_list' book.id %}" class="btn btn-outline-secondary">
                            <i class="fas fa-arrow-left"></i> 取消
                        </a>
                        
                        <button type="submit" class="btn btn-success">
                            <i class="fas fa-plus"></i> 创建章节
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>
    
    <div class="col-md-4">
        <!-- 创作指南 -->
        <div class="card">
            <div class="card-header">
                <h6 class="mb-0"><i class="fas fa-lightbulb"></i> 创作指南</h6>
            </div>
            <div class="card-body">
                <h6><i class="fas fa-star"></i> 章节标题</h6>
                <ul class="list-unstyled">
                    <li><i class="fas fa-check text-success"></i> 简洁明了</li>
                    <li><i class="fas fa-check text-success"></i> 引人入胜</li>
                    <li><i class="fas fa-check text-success"></i> 体现内容要点</li>
                </ul>
                
                <h6><i class="fas fa-file-text"></i> 内容创作</h6>
                <ul class="list-unstyled">
                    <li><i class="fas fa-check text-success"></i> 结构清晰，段落分明</li>
                    <li><i class="fas fa-check text-success"></i> 语言流畅，表达准确</li>
                    <li><i class="fas fa-check text-success"></i> 内容健康积极</li>
                    <li><i class="fas fa-check text-success"></i> 避免敏感词汇</li>
                </ul>
                
                <hr>
                
                <h6><i class="fas fa-keyboard"></i> 快捷键</h6>
                <ul class="list-unstyled">
                    <li><kbd>Tab</kbd> 缩进</li>
                    <li><kbd>Shift + Tab</kbd> 取消缩进</li>
                    <li><kbd>Ctrl + Enter</kbd> 快速提交</li>
                </ul>
            </div>
        </div>
        
        <!-- 作品信息 -->
        <div class="card mt-3">
            <div class="card-header">
                <h6 class="mb-0"><i class="fas fa-book"></i> 作品信息</h6>
            </div>
            <div class="card-body">
                <p><strong>作品名：</strong>{{ book.title|default:book.title_pending }}</p>
                <p><strong>作者：</strong>{{ book.author.display_name }}</p>
                <p><strong>创建时间：</strong>{{ book.created_at|date:"Y-m-d" }}</p>
                
                <div class="text-center">
                    <div id="wordCount" class="h4 text-primary">0</div>
                    <p class="text-muted small">字数统计</p>
                </div>
            </div>
        </div>
        
        <!-- 注意事项 -->
        <div class="card mt-3">
            <div class="card-header">
                <h6 class="mb-0"><i class="fas fa-exclamation-triangle text-warning"></i> 注意事项</h6>
            </div>
            <div class="card-body">
                <div class="alert alert-warning alert-sm">
                    <small>
                        <i class="fas fa-info-circle"></i> 
                        <strong>审核流程：</strong><br>
                        1. AI自动审核<br>
                        2. 管理员人工审核<br>
                        3. 审核通过后公开展示
                    </small>
                </div>
                
                <div class="alert alert-danger alert-sm">
                    <small>
                        <i class="fas fa-ban"></i> 
                        <strong>禁止内容：</strong><br>
                        • 违法违规内容<br>
                        • 色情暴力内容<br>
                        • 恶意攻击内容<br>
                        • 侵权抄袭内容
                    </small>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
$(document).ready(function() {
    // 自动聚焦到标题输入框
    $('#title').focus();
    
    // 监听内容变化
    $('#title, #content').on('input', function() {
        updateWordCount();
    });
    
    // 字数统计
    function updateWordCount() {
        const content = $('#content').val();
        const wordCount = content.length;
        $('#wordCount').text(wordCount.toLocaleString());
    }
    
    // 初始化字数统计
    updateWordCount();
    
    // 快捷键支持
    $(document).keydown(function(e) {
        // Ctrl + Enter 快速提交
        if (e.ctrlKey && e.keyCode === 13) {
            e.preventDefault();
            $('#chapterForm').submit();
        }
    });
    
    // 表单验证
    $('#chapterForm').submit(function(e) {
        const title = $('#title').val().trim();
        const content = $('#content').val().trim();
        
        if (!title) {
            alert('请填写章节标题');
            $('#title').focus();
            e.preventDefault();
            return;
        }
        
        if (!content) {
            alert('请填写章节内容');
            $('#content').focus();
            e.preventDefault();
            return;
        }
        
        if (title.length > 200) {
            alert('章节标题不能超过200个字符');
            $('#title').focus();
            e.preventDefault();
            return;
        }
        
        // 显示提交中状态
        $(this).find('button[type=submit]').prop('disabled', true)
               .html('<i class="fas fa-spinner fa-spin"></i> 创建中...');
    });
    
    // 离开页面提醒
    let hasContent = false;
    $('#title, #content').on('input', function() {
        hasContent = $(this).val().trim().length > 0;
    });
    
    window.onbeforeunload = function(e) {
        if (hasContent) {
            return '您有未保存的内容，确定要离开吗？';
        }
    };
    
    // 提交时不显示离开提醒
    $('#chapterForm').submit(function() {
        window.onbeforeunload = null;
    });
    
    // 字数统计颜色提示
    function updateWordCountColor() {
        const count = $('#content').val().length;
        const $counter = $('#wordCount');
        
        if (count < 500) {
            $counter.removeClass('text-warning text-success').addClass('text-primary');
        } else if (count < 2000) {
            $counter.removeClass('text-primary text-success').addClass('text-warning');
        } else {
            $counter.removeClass('text-primary text-warning').addClass('text-success');
        }
    }
    
    $('#content').on('input', updateWordCountColor);
    updateWordCountColor();
});
</script>
{% endblock %}
